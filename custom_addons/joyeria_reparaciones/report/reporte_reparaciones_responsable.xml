<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="reporte_reparaciones_responsable">
    <t t-call="web.html_container">

      <!-- üëá Fuerza fuente con cobertura Unicode amplia -->
      <style type="text/css">
        /* DejaVu Sans est√° disponible en la imagen de Odoo y wkhtmltopdf;
           mantiene acentos/√±/diacr√≠ticos sin deformar. */
        html, body, .page, .tbl-compact, .tbl-compact th, .tbl-compact td,
        .rep-title, .group-row td {
          font-family: "DejaVu Sans", "Lato", Arial, sans-serif !important;
          font-kerning: normal;
          font-variant-ligatures: none; /* evita ligaduras raras en PDF */
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }

        /* Evita cortes feos de caracteres combinados (tildes) */
        .tbl-compact th, .tbl-compact td {
          word-break: normal;           /* menos agresivo que break-word */
          overflow-wrap: break-word;    /* solo si es necesario */
          white-space: normal;
        }
      </style>

      <!-- Estilos compactos para el PDF (igual que ten√≠as) -->
      <style type="text/css">
        .tbl-compact {
          width: 100%;
          border-collapse: collapse;
          table-layout: fixed;
          font-size: 13px;
          line-height: 1.15;
        }
        .tbl-compact th, .tbl-compact td {
          border: 1px solid #000;
          padding: 2px 3px;
          vertical-align: top;
        }
        .tbl-compact thead th { background: #f2f2f2; }
        .tbl-compact col.c-rma    { width: 9%; }
        .tbl-compact col.c-cant   { width: 6%; }
        .tbl-compact col.c-prod   { width: 12%; }
        .tbl-compact col.c-modelo { width: 12%; }
        .tbl-compact col.c-metal  { width: 10%; }
        .tbl-compact col.c-ncm    { width: 9%; }
        .tbl-compact col.c-peso   { width: 7%; }
        .tbl-compact col.c-op     { width: 20%; }
        .tbl-compact col.c-fecha  { width: 9%; }
        .tbl-compact col.c-gr     { width: 7%; }
        .rep-title {
          text-align: center;
          margin: 0 0 6px 0;
          font-size: 14px;
        }
        .group-row td {
          padding: 3px !important;
          background: #ddd;
          border: 1px solid #000;
          font-weight: bold;
        }
      </style>

      <t t-foreach="docs" t-as="usuario">
        <t t-set="responsable" t-value="usuario.name"/>
        <t t-set="reparaciones"
           t-value="env['joyeria.reparacion'].sudo().search(
             [
               ('responsable_id','=', usuario.id),
               ('fecha_entrega','!=', False),
               ('estado','!=','reparado'),
               ('estado','!=','reparado y entregado'),
             ],
             order='fecha_entrega asc'
           )"/>

        <div class="page">
          <h2 class="rep-title">
            √ìrdenes de Reparaci√≥n para <t t-esc="responsable"/>
          </h2>

          <t t-set="prev_year" t-value="None"/>
          <t t-set="prev_month" t-value="None"/>

          <table class="tbl-compact">
            <colgroup>
              <col class="c-rma"/>
              <col class="c-cant"/>
              <col class="c-prod"/>
              <col class="c-modelo"/>
              <col class="c-metal"/>
              <col class="c-ncm"/>
              <col class="c-peso"/>
              <col class="c-op"/>
              <col class="c-fecha"/>
              <col class="c-gr"/>
            </colgroup>

            <thead>
              <tr>
                <th>RMA</th>
                <th>CANTIDAD</th>
                <th>PRODUCTO</th>
                <th>MODELO</th>
                <th>METAL</th>
                <th>N/CM</th>
                <th>PESO</th>
                <th>OPERACI√ìN</th>
                <th>FECHA ENTREGA</th>
                <th>GR</th>
              </tr>
            </thead>

            <tbody>
              <t t-foreach="reparaciones" t-as="r">
                <t t-if="
                  r.fecha_entrega
                  and (prev_year != r.fecha_entrega.year or prev_month != r.fecha_entrega.month)
                ">
                  <tr class="group-row">
                    <td colspan="10">
                      Mes: <t t-esc="r.fecha_entrega.strftime('%m/%Y')"/>
                    </td>
                  </tr>
                  <t t-set="prev_year"  t-value="r.fecha_entrega.year"/>
                  <t t-set="prev_month" t-value="r.fecha_entrega.month"/>
                </t>

                <tr>
                  <td><t t-esc="r.name"/></td>
                  <td><t t-esc="r.cantidad or 0"/></td>
                  <td><t t-esc="r.tipo_joya or ''"/></td>
                  <td><t t-esc="r.modelo or ''"/></td>
                  <td><t t-esc="r.metal or ''"/></td>
                  <td><t t-esc="r.n_cm_fabricacion or r.n_cm_reparacion or ''"/></td>
                  <td><t t-esc="r.peso_valor or 0"/></td>
                  <td><t t-esc="r.solicitud_cliente or ''"/></td>
                  <td><t t-esc="r.fecha_entrega and r.fecha_entrega.strftime('%d/%m/%Y') or ''"/></td>
                  <td><t t-esc="''"/></td>
                </tr>
              </t>
            </tbody>
          </table>
        </div>
      </t>
    </t>
  </template>
</odoo>

<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="reporte_reparaciones_responsable">
    <t t-call="web.html_container">

      <!-- Estilos compactos para el PDF -->
      <style type="text/css">
        .tbl-compact {
          width: 100%;
          border-collapse: collapse;
          table-layout: fixed;        /* fuerza distribución ajustada */
          font-size: 10px;            /* más pequeño */
          line-height: 1.15;          /* filas más bajas */
        }
        .tbl-compact th, .tbl-compact td {
          border: 1px solid #000;
          padding: 2px 3px;           /* menos padding (alto y ancho) */
          vertical-align: top;        /* evita celdas altas por baseline */
          word-break: break-word;
          overflow-wrap: anywhere;
          white-space: normal;        /* permite salto de línea */
        }
        .tbl-compact thead th {
          background: #f2f2f2;
        }
        /* Anchos por columna (10 columnas) */
        .tbl-compact col.c-rma      { width: 9%; }
        .tbl-compact col.c-cant     { width: 6%; }
        .tbl-compact col.c-prod     { width: 12%; }
        .tbl-compact col.c-modelo   { width: 12%; }
        .tbl-compact col.c-metal    { width: 10%; }
        .tbl-compact col.c-ncm      { width: 9%; }
        .tbl-compact col.c-peso     { width: 7%; }
        .tbl-compact col.c-op       { width: 20%; }  /* OPERACION: texto largo, pero ajustado */
        .tbl-compact col.c-fecha    { width: 8%; }
        .tbl-compact col.c-gr       { width: 7%; }
        /* Título más compacto */
        .rep-title {
          text-align: center;
          margin: 0 0 6px 0;
          font-size: 14px;
        }
        /* Cabecera de mes más compacta */
        .group-row td {
          padding: 3px !important;
          background: #ddd;
          border: 1px solid #000;
          font-weight: bold;
        }
      </style>

      <t t-foreach="docs" t-as="usuario">
        <t t-set="responsable" t-value="usuario.name"/>
        <t t-set="reparaciones"
           t-value="env['joyeria.reparacion'].sudo().search(
             [
               ('responsable_id','=', usuario.id),
               ('fecha_entrega','!=', False),
               ('estado','!=','reparado'),
             ],
             order='fecha_entrega asc'
           )"/>

        <div class="page">
          <h2 class="rep-title">
            Ordenes de Reparacion para <t t-esc="responsable"/>
          </h2>

          <t t-set="prev_year" t-value="None"/>
          <t t-set="prev_month" t-value="None"/>

          <table class="tbl-compact">
            <!-- Definición de anchos de columnas -->
            <colgroup>
              <col class="c-rma"/>
              <col class="c-cant"/>
              <col class="c-prod"/>
              <col class="c-modelo"/>
              <col class="c-metal"/>
              <col class="c-ncm"/>
              <col class="c-peso"/>
              <col class="c-op"/>
              <col class="c-fecha"/>
              <col class="c-gr"/>
            </colgroup>

            <thead>
              <tr>
                <th>RMA</th>
                <th>CANTIDAD</th>
                <th>PRODUCTO</th>
                <th>MODELO</th>
                <th>METAL</th>
                <th>N/CM</th>
                <th>PESO</th>
                <th>OPERACION</th>
                <th>FECHA ENTREGA</th>
                <th>GR</th>
              </tr>
            </thead>

            <tbody>
              <t t-foreach="reparaciones" t-as="r">
                <!-- Cabecera de mes/año al cambiar -->
                <t t-if="
                  r.fecha_entrega
                  and (prev_year != r.fecha_entrega.year or prev_month != r.fecha_entrega.month)
                ">
                  <tr class="group-row">
                    <td colspan="10">
                      Mes: <t t-esc="r.fecha_entrega.strftime('%m/%Y')"/>
                    </td>
                  </tr>
                  <t t-set="prev_year" t-value="r.fecha_entrega.year"/>
                  <t t-set="prev_month" t-value="r.fecha_entrega.month"/>
                </t>

                <!-- Fila de datos (contenido intacto) -->
                <tr>
                  <td><t t-esc="r.name"/></td>
                  <td><t t-esc="r.cantidad or 0"/></td>
                  <td><t t-esc="r.tipo_joya or ''"/></td>
                  <td><t t-esc="r.modelo or ''"/></td>
                  <td><t t-esc="r.metal or ''"/></td>
                  <td><t t-esc="r.n_cm_fabricacion or r.n_cm_reparacion or ''"/></td>
                  <td><t t-esc="r.peso_valor or 0"/></td>
                  <!-- OJO: antes tenía padding:75px; se compacta para no inflar la fila -->
                  <td><t t-esc="r.solicitud_cliente or ''"/></td>
                  <td><t t-esc="r.fecha_entrega and r.fecha_entrega.strftime('%d/%m/%Y') or ''"/></td>
                  <td><t t-esc="''"/></td>
                </tr>
              </t>
            </tbody>
          </table>
        </div>
      </t>
    </t>
  </template>
</odoo>
